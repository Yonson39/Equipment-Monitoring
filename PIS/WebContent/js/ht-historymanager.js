!function(R,O,y){"use strict";var I="ht",r=R[I],e=r.Default,k=e.def,p=e.getInternal();r.HistoryManager=function(n){this._histories=[],this.setDataModel(n)},k(r.HistoryManager,O,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var P=this;P._betweenTransaction++,1===P._betweenTransaction&&(P._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var U=this,s=U._histories;U._betweenTransaction>0&&U._betweenTransaction--,0===U._betweenTransaction&&(U._transactionHistories&&U._transactionHistories.length&&(s=s.slice(0,U._historyIndex+1),s.push(U._transactionHistories),s.length>U._maxHistoryCount&&(s=s.slice(s.length-U._maxHistoryCount)),U.setHistories(s),U.setHistoryIndex(s.length-1,!0)),delete U._transactionHistories)}},setDataModel:function(F){var I=this,H=I._dataModel;H!==F&&(H&&(delete H._historyManager,H.ump(I.handleDataModelPropertyChange,I),H.umm(I.$5p,I),H.umd(I.$6p,I),H.removeHierarchyChangeListener(I.handleHierarchyChange,I),H.removeIndexChangeListener(I.handleIndexChange,I)),I._dataModel=F,F&&(F._historyManager=I,F.mp(I.handleDataModelPropertyChange,I),F.mm(I.$5p,I),F.md(I.$6p,I),F.addHierarchyChangeListener(I.handleHierarchyChange,I),F.addIndexChangeListener(I.handleIndexChange,I)),I.fp("dataModel",H,F),I.clear())},setHistoryIndex:function(R,t){var i=this,r=i._historyIndex,j=i._histories.length;if(-1>R?R=-1:R>=j&&(R=j-1),r!==R){if(!t){var X=R-r;X>0?i.$2p(X):0>X&&i.$1p(-X)}i._historyIndex=R,i.fp("historyIndex",r,R),i.dataModel&&i.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(m){var A=this,z=A._histories,s=A._maxHistoryCount;(!m||0>=m)&&(m=10),s!==m&&(A._maxHistoryCount=m,A.fp("maxHistoryCount",s,m),z.length>m&&A.clear())},cloneValue:function(y){return r.Default.clone(y)},isPropertyUndoable:function(A){return A&&!this.ignoredPropertyMap[A]},$5p:function(Q){this.handleChange(Q,Q.kind)},$6p:function(C){this.handleChange(C,"property")},handleHierarchyChange:function(k){this.handleChange(k,"hierarchy")},handleIndexChange:function(P){this.handleChange(P,"index")},handleDataModelPropertyChange:function(Z){this.handleChange(Z,"dataModelProperty")},toChildrenInfo:function(Y){var R={};return R.data=Y,R.children=[],Y.eachChild(function(t){R.children.push(this.toChildrenInfo(t))},this),R},restoreChildren:function(d){var i=d.data;d.children.forEach(function(c){var f=c.data;f.getParent()!==i&&i.addChild(f),this._dataModel.contains(f)||this._dataModel.add(f),this.restoreChildren(c)},this)},handleChange:function(K,D){var S=this;if(!S._disabled&&!S._isUndoRedoing){var $,z=(S._histories,K.data),J=K.property;if("property"===D)S.isPropertyUndoable(J,z)&&($={kind:D,data:z,property:J,oldValue:S.cloneValue(K.oldValue,z,J),newValue:S.cloneValue(K.newValue,z,J),event:K});else if("hierarchy"===D||"index"===D)$={kind:D,data:z,oldIndex:K.oldIndex,newIndex:K.newIndex,event:K};else if("clear"===D)$={kind:D,json:K.json,event:K};else if("add"===D){if($={kind:D,data:z,event:K,childrenInfo:this.toChildrenInfo(z),parent:z.getParent()},$.parent){var T=S._dataModel.getSiblings(z);$.siblingsIndex=T.indexOf(z)}z instanceof r.Node&&($.host=z.getHost(),$.attaches=z.getAttaches()?z.getAttaches().toArray():y),z instanceof r.Edge&&($.source=z.getSource(),$.target=z.getTarget())}else"remove"===D?$={kind:D,data:z,event:K}:"dataModelProperty"===D&&($={kind:D,property:J,oldValue:S.cloneValue(K.oldValue,z,J),newValue:S.cloneValue(K.newValue,z,J),event:K});S.addHistory($)}},addHistory:function(W){var p=this;if(W)if(p._betweenTransaction){var V=!1;if("property"===W.kind||"dataModelProperty"===W.kind)for(var z=p._transactionHistories.length-1;z>=0;z--){var B=p._transactionHistories[z];if(W.kind===B.kind&&W.property===B.property&&W.data===B.data){W.oldValue=B.oldValue,p._transactionHistories[z]=W,V=!0;break}}V||p._transactionHistories.push(W)}else{var O=p._histories;O=O.slice(0,p._historyIndex+1),O.push([W]),O.length>p._maxHistoryCount&&(O=O.slice(O.length-p._maxHistoryCount)),p.setHistories(O),p.setHistoryIndex(O.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(c){(!c||0>=c)&&(c=1),this.setHistoryIndex(this._historyIndex-c)},$1p:function(V){if(this.canUndo()){var W,b=this,F=b._dataModel,S=b._histories,J=b._historyIndex;for(b._isUndoRedoing=!0,e.setIsolating(!0);V>0;){if(J>=0&&J<S.length){W=S[J],J--;for(var U=W.length-1;U>=0;U--){var K=W[U],A=K.kind,t=K.data,x=K.property,Z=K.event,I=this.cloneValue(K.oldValue,t,x);if(K.undo)K.undo();else if("add"===A)F.remove(t,{keepChildren:!0});else if("remove"===A)F.contains(t)||F.add(t,Z.rootsIndex,Z.datasIndex);else if("clear"===A)F.deserialize(e.clone(K.json));else if("property"===A)if("parent"===x)I?I.addChild(t,Z.oldIndex):(t.setParent(I),Z.oldIndex>=0&&F.moveTo(t,Z.oldIndex));else{var D=null;0===x.indexOf("a:")?(D="attr",x=x.replace("a:","")):0===x.indexOf("s:")&&(D="style",x=x.replace("s:","")),p.setPropertyValue(t,D,x,I)}else if("dataModelProperty"===A){var D=null;0===x.indexOf("a:")?(D="attr",x=x.replace("a:","")):0===x.indexOf("s:")&&(D="style",x=x.replace("s:","")),p.setPropertyValue(F,D,x,I)}else"hierarchy"===A?F.moveTo(t,K.oldIndex):"index"===A&&F.moveToIndex(t,K.oldIndex)}}V--}e.setIsolating(!1),delete b._isUndoRedoing}},redo:function(L){(!L||0>=L)&&(L=1),this.setHistoryIndex(this._historyIndex+L)},$2p:function(C){if(this.canRedo()){var x,n=this,m=n._dataModel,H=n._histories,t=n._historyIndex;for(n._isUndoRedoing=!0,e.setIsolating(!0);C>0;){if(t>=-1&&t<H.length-1){t++,x=H[t];for(var Y=0;Y<x.length;Y++){var V=x[Y],Q=V.kind,W=V.data,Z=V.property,U=V.event,I=this.cloneValue(V.newValue,W,Z);if(V.redo)V.redo();else if("add"===Q)V.parent&&!W.getParent()&&V.parent.addChild(W,V.siblingsIndex),m.contains(W)||m.add(W,U.rootsIndex,U.datasIndex),this.restoreChildren(V.childrenInfo),W instanceof r.Node&&(W.setHost(V.host),V.attaches&&V.attaches.forEach(function(F){F.setHost(W)})),W instanceof r.Edge&&(W.setSource(V.source),W.setTarget(V.target));else if("remove"===Q)m.remove(W);else if("clear"===Q)m.clear();else if("property"===Q)if("parent"===Z)I?I.addChild(W,U.newIndex):(W.setParent(I),U.newIndex>=0&&m.moveTo(W,U.newIndex));else{var c=null;0===Z.indexOf("a:")?(c="attr",Z=Z.replace("a:","")):0===Z.indexOf("s:")&&(c="style",Z=Z.replace("s:","")),p.setPropertyValue(W,c,Z,I)}else if("dataModelProperty"===Q){var c=null;0===Z.indexOf("a:")?(c="attr",Z=Z.replace("a:","")):0===Z.indexOf("s:")&&(c="style",Z=Z.replace("s:","")),p.setPropertyValue(m,c,Z,I)}else"hierarchy"===Q?m.moveTo(W,V.newIndex):"index"===Q&&m.moveToIndex(W,V.newIndex)}}C--}e.setIsolating(!1),delete n._isUndoRedoing}},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);